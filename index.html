<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>経営コンパス Pro｜診断士・経営者向け思考整理</title>
  
  <!-- 
     Original concept by User
     Refined for SME Consultants (中小企業診断士)
     Theme: Premium Glass (Aurora Gradient) + Dark Mode Support
     Updated: v4.9 Added Custom Favicon (Insta-style Compass Icon)
  -->
  
  <!-- Favicon: Generated from user's image concept (Purple Gradient Compass) -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZGVmcz48bGluZWFyR3JhZGllbnQgaWQ9ImciIHgxPSIwIiB5MT0iMCIgeDI9IjEiIHkyPSIxIj48c3RvcCBvZmZzZXQ9IjAlIiBzdG9wLWNvbG9yPSIjNGY0NmU1Ii8+PHN0b3Agb2Zmc2V0PSI1MCUiIHN0b3AtY29sb3I9IiNhODU1ZjciLz48c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiNlYzQ4OTkiLz48L2xpbmVhckdyYWRpZW50PjwvZGVmcz48cmVjdCB4PSIwIiB5PSIwIiB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHJ4PSIxNiIgZmlsbD0idXJsKCNnKSIvPjxwYXRoIGQ9Ik0zMiAxNmw2IDEwIDEwIDYtMTAgNi02IDEwLTYtMTAtMTAtNiAxMC02eiIgZmlsbD0iI2ZmZiIvPjxjaXJjbGUgY3g9IjMyIiBjeT0iMzIiIHI9IjIiIGZpbGw9InVybCgjZykiLz48L3N2Zz4=">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  
  <style>
    :root{
      --text-main: #1e293b;
      --text-muted: #475569;
      --accent: #2563eb;
      --accent-hover: #1d4ed8;
      
      --insta-grad: linear-gradient(45deg, #405de6, #5851db, #833ab4, #c13584, #e1306c, #fd1d1d);
      --aurora-grad: linear-gradient(135deg, #6366f1 0%, #a855f7 50%, #ec4899 100%);
      
      --glass-bg: rgba(255, 255, 255, 0.90);
      --glass-border: rgba(255, 255, 255, 0.6);
      --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
      --card-bg: rgba(255, 255, 255, 0.7);
      --input-bg: #ffffff;
      --input-focus-bg: #ffffff;
      --preview-bg: #ffffff;
      --preview-text: #334155;
      
      --danger: #ef4444;
      --warning: #f59e0b;
      --success: #10b981;
      
      --bg-color: #f8fafc;
    }

    [data-theme="dark"] {
      --text-main: #f1f5f9;
      --text-muted: #94a3b8;
      --accent: #60a5fa;
      --accent-hover: #3b82f6;
      --insta-grad: linear-gradient(45deg, #405de6, #5851db, #833ab4, #c13584, #e1306c, #fd1d1d);
      --aurora-grad: linear-gradient(135deg, #818cf8 0%, #c084fc 50%, #f472b6 100%);
      --glass-bg: rgba(30, 41, 59, 0.90);
      --glass-border: rgba(255, 255, 255, 0.1);
      --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
      --card-bg: rgba(30, 41, 59, 0.6);
      --input-bg: rgba(15, 23, 42, 0.8);
      --input-focus-bg: #0f172a;
      --preview-bg: #1e293b;
      --preview-text: #e2e8f0;
      --bg-color: #0f172a;
    }

    body{
      margin:0; color:var(--text-main);
      font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
      background-color: var(--bg-color);
      background-image: 
        radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.15) 0px, transparent 50%),
        radial-gradient(at 100% 0%, rgba(168, 85, 247, 0.15) 0px, transparent 50%),
        radial-gradient(at 100% 100%, rgba(236, 72, 153, 0.15) 0px, transparent 50%),
        radial-gradient(at 0% 100%, rgba(234, 179, 8, 0.1) 0px, transparent 50%);
      background-attachment: fixed; background-size: cover;
      min-height:100vh;
      -webkit-font-smoothing: antialiased;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    .wrap{max-width:1200px; margin:0 auto; padding:24px 20px 60px;}
    
    .top{
      background: var(--glass-bg); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
      border: 1px solid var(--glass-border); border-radius:20px; padding:20px 28px;
      display:flex; gap:16px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      box-shadow: var(--glass-shadow); margin-bottom: 24px; transition: all 0.3s;
    }
    .ttl-area h1{
      margin:0; font-size:22px; letter-spacing:.03em; font-weight:800; color:var(--text-main);
      display: flex; align-items: center; gap: 12px;
    }
    .ttl-area h1 i { 
      background: var(--aurora-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      filter: drop-shadow(0 2px 4px rgba(168, 85, 247, 0.2));
    }
    .ttl-area p{margin:4px 0 0; color:var(--text-muted); font-size:12px; font-weight:600; opacity:0.8;}
    .rightTop{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-left: auto; }
    .separator { width: 1px; height: 24px; background: currentColor; opacity: 0.1; margin: 0 8px; }

    /* Progress Bar */
    .progress-section { margin-bottom: 24px; padding: 0 4px; }
    .progress-label {
      display: flex; justify-content: space-between; font-size: 12px; font-weight: 700; 
      color: var(--text-muted); margin-bottom: 8px; align-items: center;
    }
    .progress-steps { font-size:10px; opacity:0.5; font-weight:500; display:flex; gap:10px; transition: opacity 0.3s; }
    .progress-steps span.done { color: #ec4899; font-weight:800; opacity: 1; text-shadow: 0 0 10px rgba(236, 72, 153, 0.2); }
    .progress-steps i.done { color: #ec4899; opacity: 1; }
    .progress-track {
      height: 8px; background: rgba(0,0,0,0.06); border-radius: 10px; overflow: hidden; position: relative;
    }
    [data-theme="dark"] .progress-track { background: rgba(255,255,255,0.1); }
    .progress-fill {
      height: 100%; background: var(--insta-grad);
      width: 0%; transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
      border-radius: 10px; box-shadow: 0 0 12px rgba(225, 48, 108, 0.5);
    }

    /* Tabs */
    .tabs{ display:flex; gap:10px; overflow-x:auto; padding-bottom:12px; margin-bottom: 20px; padding-left: 4px; }
    .tabs::-webkit-scrollbar{height:4px;}
    .tabs::-webkit-scrollbar-thumb{background:rgba(0,0,0,0.1); border-radius:2px;}
    .tab{
      cursor:pointer; white-space:nowrap;
      background: var(--card-bg); border: 1px solid transparent; color:var(--text-muted);
      padding:10px 22px; border-radius:50px;
      font-size:13px; font-weight:700; transition:all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
      display: flex; align-items: center; gap: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.04); position: relative;
    }
    .tab:hover{ transform: translateY(-2px); color: #c13584; background: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .tab.active{ background: var(--aurora-grad); color:#fff; box-shadow: 0 6px 16px rgba(168, 85, 247, 0.3); padding-right: 22px !important; }
    .tab.completed { padding-right: 34px; border-color: rgba(16, 185, 129, 0.3); }
    .tab.completed::after { content: "\f00c"; font-family: "Font Awesome 6 Free"; font-weight: 900; position: absolute; right: 14px; font-size: 10px; color: #10b981; }
    .tab.active.completed::after { color: rgba(255,255,255,0.8); }
    .tab[data-id="output"] { border: 1px dashed var(--accent); color: var(--accent); margin-left: auto; }
    .tab[data-id="output"].active { border:none; color: #fff; background: linear-gradient(135deg, #7c3aed, #9333ea); }

    /* Layout */
    .panel{ animation: fadeIn 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); }
    @keyframes fadeIn { from{opacity:0; transform:translateY(15px);} to{opacity:1; transform:translateY(0);} }
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:28px;}
    @media (max-width:900px){ .grid{grid-template-columns:1fr;} }

    .card{
      background: var(--glass-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border); border-radius:24px; padding:32px;
      box-shadow: var(--glass-shadow); display:flex; flex-direction:column;
      position: relative; overflow: hidden; transition: all 0.3s;
    }
    .card-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; padding-bottom: 16px; border-bottom: 1px solid rgba(0,0,0,0.05); }
    .cardTitle{ margin:0; font-size:16px; font-weight:800; color:var(--text-main); display:flex; align-items:center; gap:10px; letter-spacing: 0.02em; }
    .cardTitle i { color: #833ab4; opacity:0.8; }
    
    .field-wrapper { margin-bottom: 28px; }
    label{ display:block; font-size:13px; color:var(--text-main); opacity: 0.8; margin:0 0 10px; font-weight:700; letter-spacing: 0.04em; }
    
    input, textarea{
      width:100%; box-sizing:border-box; background: var(--input-bg);
      border: 1px solid rgba(0,0,0,0.1);
      color:var(--text-main); border-radius:12px;
      padding:16px; font-size:15px; outline:none; transition:all 0.3s;
      font-family:inherit; box-shadow: 0 2px 5px rgba(0,0,0,0.02);
    }
    input:focus, textarea:focus{ border-color: #c13584; background:var(--input-focus-bg); box-shadow: 0 0 0 4px rgba(193, 53, 132, 0.1); }
    input::placeholder, textarea::placeholder { color: #94a3b8; opacity: 1; font-size: 13px; letter-spacing: 0.01em; }
    textarea{min-height:140px; resize:vertical; line-height:1.7;}

    /* View Switcher */
    .view-switch { display: flex; background: rgba(0,0,0,0.04); border-radius: 12px; padding: 4px; gap: 2px; }
    [data-theme="dark"] .view-switch { background: rgba(255,255,255,0.08); }
    .v-btn {
      border: none; background: transparent; color: var(--text-muted); font-size: 12px; font-weight: 700;
      padding: 8px 16px; border-radius: 10px; cursor: pointer; box-shadow: none; margin: 0; transition: all 0.2s;
    }
    .v-btn:hover { color: var(--text-main); }
    .v-btn.active { background: #fff; color: #833ab4; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    [data-theme="dark"] .v-btn.active { background: #334155; color: #fff; }

    .out-wrap{flex:1; display:flex; flex-direction:column; position: relative;}
    .view-content { display: none; flex: 1; flex-direction: column; animation: fadeIn 0.3s ease; }
    .view-content.active { display: flex; }

    /* Next Action Guide Style */
    .next-action-guide {
      background: linear-gradient(135deg, #fff0f5 0%, #fff 100%);
      border: 1px solid #fecaca; border-radius: 12px; padding: 20px;
      margin-bottom: 20px; box-shadow: 0 4px 12px rgba(236, 72, 153, 0.1);
    }
    [data-theme="dark"] .next-action-guide {
      background: rgba(236, 72, 153, 0.1); border-color: rgba(236, 72, 153, 0.3);
    }
    .na-title {
      font-size: 14px; font-weight: 800; color: #db2777; margin: 0 0 10px;
      display: flex; align-items: center; gap: 8px;
    }
    .na-desc { font-size: 12px; color: var(--text-muted); margin: 0 0 16px; line-height: 1.6; }
    .ai-links { display: flex; gap: 10px; flex-wrap: wrap; }
    .ai-link-btn {
      flex: 1; text-decoration: none; font-size: 12px; font-weight: 700;
      padding: 10px 14px; border-radius: 8px; display: inline-flex; justify-content: center; align-items: center; gap: 6px;
      transition: all 0.2s; background: #fff; border: 1px solid rgba(0,0,0,0.1); color: var(--text-muted);
      box-shadow: 0 2px 4px rgba(0,0,0,0.05); min-width: 90px;
    }
    [data-theme="dark"] .ai-link-btn { background: rgba(30, 41, 59, 0.8); border-color: rgba(255,255,255,0.1); }
    .ai-link-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    
    .ai-link-btn.chatgpt:hover { color: #10a37f; border-color: #10a37f; }
    .ai-link-btn.gemini:hover { color: #4285f4; border-color: #4285f4; }
    .ai-link-btn.notebooklm:hover { color: #f59e0b; border-color: #f59e0b; }

    .out{
      flex:1; white-space:pre-wrap; background: var(--preview-bg); 
      border: 1px solid rgba(0,0,0,0.05); color: var(--preview-text);
      border-radius:12px; padding:32px; font-size:14px; line-height:1.9;
      overflow-y:auto; max-height:600px; box-shadow: inset 0 2px 6px rgba(0,0,0,0.02);
    }
    .prompt-box {
      flex: 1; width: 100%; box-sizing: border-box; resize: none;
      background: #f8fafc; color: #334155; border: 1px solid rgba(0,0,0,0.1);
      padding: 24px; font-family: "Menlo", "Monaco", monospace; font-size: 13px; line-height: 1.7;
      border-radius: 12px; max-height: 500px; overflow-y: auto;
    }
    [data-theme="dark"] .prompt-box { background: #0f172a; color: #cbd5e1; border-color: rgba(255,255,255,0.1); }
    .prompt-note { font-size: 12px; color: #c13584; margin-top: 10px; text-align: right; font-weight: 600; }

    /* Buttons */
    .btns{display:flex; gap:12px; flex-wrap:wrap; margin-top:32px;}
    button{
      border:1px solid rgba(0,0,0,0.1); background: rgba(255,255,255,0.9);
      color: var(--text-muted); padding:12px 24px; border-radius:12px; cursor:pointer;
      font-size:13px; font-weight:700; display:inline-flex; align-items:center; gap:8px;
      transition:all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1); box-shadow: 0 2px 4px rgba(0,0,0,0.03);
    }
    [data-theme="dark"] button { border-color: rgba(255,255,255,0.1); background: rgba(30, 41, 59, 0.8); }
    button:hover{ transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.08); color: var(--text-main); }
    
    button.primary{ background: linear-gradient(135deg, #405de6, #5851db); border:none; color:#fff !important; box-shadow: 0 4px 14px rgba(88, 81, 219, 0.3); }
    button.primary:hover{ background: linear-gradient(135deg, #3549c4, #4840b5); color:#fff; }
    
    button.ai-btn{ background: var(--aurora-grad); border:none; color:#fff !important; box-shadow: 0 4px 14px rgba(236, 72, 153, 0.3); }
    button.ai-btn:hover{ opacity: 0.9; color:#fff; }
    
    button.pdf-btn{ color: #e1306c; border-color: rgba(225, 48, 108, 0.3); }
    button.pdf-btn:hover{ background: #fff5f8; border-color: #e1306c; }
    [data-theme="dark"] button.pdf-btn:hover { background: rgba(225, 48, 108, 0.1); }

    button.danger{ color:var(--danger); background: transparent; border-color: rgba(239, 68, 68, 0.3); }
    button.danger:hover{ background: #fef2f2; border-color: var(--danger); }
    [data-theme="dark"] button.danger:hover { background: rgba(239, 68, 68, 0.1); }
    
    button.confirming {
      background: var(--warning) !important; color: #fff !important; border-color: transparent !important; animation: pulse 0.5s;
    }
    @keyframes pulse { 0%{transform:scale(1);} 50%{transform:scale(1.05);} 100%{transform:scale(1);} }

    /* Toast */
    .toast-container { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 10000; pointer-events: none; }
    .toast {
      background: rgba(30, 41, 59, 0.95); color: #fff; padding: 12px 28px; border-radius: 50px;
      font-size: 14px; font-weight: 600; box-shadow: 0 15px 30px rgba(0,0,0,0.2);
      display: flex; align-items: center; gap: 12px;
      opacity: 0; transform: translateY(20px) scale(0.9); transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .toast.show { opacity: 1; transform: translateY(0) scale(1); }
    .toast i { color: #4ade80; } .toast.error i { color: #f87171; }

    /* Modal */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(8px); z-index: 9999; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s ease; }
    .modal-overlay.open { display: flex; opacity: 1; }
    .modal-content {
      background: var(--glass-bg); backdrop-filter: blur(24px); border: 1px solid var(--glass-border); width: 90%; max-width: 550px;
      border-radius: 24px; padding: 40px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      position: relative; transform: translateY(20px); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); color: var(--text-main);
    }
    .modal-overlay.open .modal-content { transform: translateY(0); }
    .modal-close { position: absolute; top: 20px; right: 24px; font-size: 24px; color: var(--text-muted); cursor: pointer; background:none; border:none; }
    .modal-title { font-size: 22px; font-weight: 800; color: var(--text-main); margin-bottom: 24px; border-bottom: 1px solid rgba(0,0,0,0.06); padding-bottom: 16px; display: flex; align-items: center; gap: 12px; }
    .settings-footer { margin-top: 40px; border-top: 1px dashed rgba(0,0,0,0.1); padding-top: 24px; display: flex; justify-content: space-between; align-items: center; gap: 10px; }
    .btn-link { background: rgba(0,0,0,0.03); border: 1px solid transparent; color: var(--text-muted); padding: 10px 18px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
    .btn-link:hover { background: rgba(0,0,0,0.06); color: var(--text-main); transform: translateY(-1px); }
    .btn-link.demo { color: #c13584; background: rgba(193, 53, 132, 0.05); }
    .btn-link.demo:hover { background: rgba(193, 53, 132, 0.1); }
    .btn-link.reset { color: var(--danger); }
    .footer{ margin-top:60px; text-align:center; color:var(--text-muted); opacity:0.6; font-size:12px; font-weight: 500; }
    @media print { .top, .tabs, #leftCard, .btns, .footer, .rightTop button, #toastContainer, .modal-overlay, .progress-section {display:none !important;} .wrap{max-width:100%;} .grid{display:block;} .card{box-shadow:none; border:none;} .out{border:none;} #preview::before { content: "経営コンパス レポート"; display:block; font-size:24px; font-weight:bold; margin-bottom:20px; border-bottom:2px solid #000; padding-bottom:10px; } }
  </style>
</head>
<body>

<div class="wrap">
  <!-- Header -->
  <div class="top">
    <div class="ttl-area">
      <h1><i class="fa-solid fa-compass"></i> 経営コンパス Pro</h1>
      <p>診断士・経営者のための思考整理 & AI共創ツール</p>
    </div>
    <div class="rightTop">
      <button id="btnUploadJson"><i class="fa-solid fa-upload"></i> データ読込</button>
      <button class="primary" id="btnDownloadJson"><i class="fa-solid fa-download"></i> データ保存</button>
      <div class="separator"></div>
      <button id="btnUsage"><i class="fa-solid fa-circle-question"></i> 使い方</button>
      <button id="btnSettings"><i class="fa-solid fa-gear"></i> 設定</button>
      <input type="file" id="fileInput" accept=".json" style="display:none">
      <input type="file" id="pdfInput" accept="application/pdf" style="display:none">
    </div>
  </div>

  <!-- Progress Bar -->
  <div class="progress-section">
    <div class="progress-label">
      <span><i class="fa-solid fa-chart-pie" style="color:#c13584; margin-right:6px;"></i>分析完了率</span>
      <div class="progress-steps">
        <span id="step1">Step1.入力</span> <i class="fa-solid fa-angle-right" id="arrow1"></i>
        <span id="step2">Step2.確認</span> <i class="fa-solid fa-angle-right" id="arrow2"></i>
        <span id="step3">Step3.出力</span>
      </div>
      <span id="progressText">0%</span>
    </div>
    <div class="progress-track">
      <div class="progress-fill" id="progressFill"></div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs" id="tabs"></div>

  <!-- Main Panel -->
  <div class="panel" id="panel">
    <div class="grid">
      <!-- Input Column -->
      <div class="card" id="leftCard">
        <div class="card-header">
          <p class="cardTitle"><i class="fa-solid fa-pen-to-square"></i> <span id="leftTitle">入力</span></p>
          <div style="display:flex; gap:8px;">
            <button class="pdf-btn" id="btnLoadPdf" style="padding:6px 14px; font-size:11px; border-radius:20px;"><i class="fa-regular fa-file-pdf"></i> PDF読込</button>
            <button class="danger" id="btnClearTab" style="padding:6px 14px; font-size:11px; border-radius:20px;">クリア</button>
          </div>
        </div>
        <div id="formArea"></div>
        <div class="btns">
          <button class="primary" id="btnSaveTab">一時保存</button>
          <!-- Updated Label -->
          <button class="ai-btn" id="btnGenAiPrompt"><i class="fa-solid fa-robot"></i> プロンプト作成 (コピー)</button>
        </div>
      </div>

      <!-- Preview Column -->
      <div class="card" id="rightCard">
        <div class="card-header">
          <!-- View Switcher -->
          <div class="view-switch">
            <button class="v-btn active" id="btnViewSheet" onclick="switchView('sheet')"><i class="fa-solid fa-file-lines"></i> プレビュー</button>
            <button class="v-btn" id="btnViewPrompt" onclick="switchView('prompt')"><i class="fa-solid fa-robot"></i> AIプロンプト</button>
          </div>
          <button id="btnCopyRight" style="padding:6px 14px; font-size:11px; border-radius:20px;"><i class="fa-regular fa-copy"></i> コピー</button>
        </div>
        
        <div class="out-wrap">
          <!-- Sheet View -->
          <div id="viewSheet" class="view-content active">
            <div class="out" id="preview"></div>
          </div>
          <!-- Prompt View with Next Action Guide -->
          <div id="viewPrompt" class="view-content">
            <div class="next-action-guide">
              <div class="na-title"><i class="fa-solid fa-check-circle"></i> プロンプトの準備完了！（コピー済み）</div>
              <p class="na-desc">AIツールを開き、入力欄に貼り付け（Ctrl+V）て送信してください。</p>
              <div class="ai-links">
                <a href="https://chatgpt.com/" target="_blank" class="ai-link-btn chatgpt"><i class="fa-solid fa-arrow-up-right-from-square"></i> ChatGPT</a>
                <a href="https://gemini.google.com/" target="_blank" class="ai-link-btn gemini"><i class="fa-solid fa-arrow-up-right-from-square"></i> Gemini</a>
                <a href="https://notebooklm.google.com/" target="_blank" class="ai-link-btn notebooklm"><i class="fa-solid fa-book"></i> NotebookLM</a>
              </div>
            </div>
            <textarea class="prompt-box" id="promptPreview" readonly placeholder="「プロンプト作成 (コピー)」ボタンを押すと、ここに生成された命令文が表示されます。"></textarea>
            <p class="prompt-note"><i class="fa-solid fa-arrow-up"></i> このテキストがクリップボードにコピーされています</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="footer">テスト版（ベータ版） © 2026 SPC</div>
</div>

<div class="toast-container" id="toastContainer"></div>

<!-- Usage/Settings Modals -->
<div class="modal-overlay" id="usageModal">
  <div class="modal-content">
    <button class="modal-close" id="btnCloseUsage"><i class="fa-solid fa-xmark"></i></button>
    <div class="modal-title"><i class="fa-solid fa-circle-question"></i> 目的・使い方</div>
    <div class="modal-body">
      <span class="usage-h">目的</span>
      <p style="font-size:14px; color:var(--text-muted); margin-bottom:20px;">本ツールは、経営者や診断士の「想い」や「戦略」を言語化し、AIを活用して高品質な事業計画書や分析資料を効率的に作成する支援ツールです。</p>
      <span class="usage-h">使い方</span>
      <ul class="usage-list">
        <li><strong>入力：</strong> 左側のタブを選び、各項目を入力します。「PDF読込」で資料からの自動転記も可能です。</li>
        <li><strong>確認：</strong> 「一時保存」で進捗85%に。プレビューで内容を確認します。</li>
        <li><strong>出力：</strong> 「プロンプト作成」で進捗100%に。生成された命令文をChatGPT等に渡します。</li>
      </ul>
    </div>
  </div>
</div>
<div class="modal-overlay" id="settingsModal">
  <div class="modal-content" style="max-width:400px;">
    <button class="modal-close" id="btnCloseSettings"><i class="fa-solid fa-xmark"></i></button>
    <div class="modal-title"><i class="fa-solid fa-gear"></i> 設定</div>
    <div class="modal-body">
      <div class="settings-row">
        <span class="settings-label">カラーテーマ</span>
        <div class="theme-opts">
          <button class="theme-btn active" id="themeLight" onclick="setTheme('light')" style="width:100%"><i class="fa-regular fa-sun"></i> ライト</button>
          <button class="theme-btn" id="themeDark" onclick="setTheme('dark')" style="width:100%"><i class="fa-regular fa-moon"></i> ダーク</button>
        </div>
      </div>
      <div class="settings-footer">
        <button class="btn-link demo" id="btnLoadDemo"><i class="fa-solid fa-wand-magic-sparkles"></i> デモデータ読込</button>
        <button class="btn-link reset" id="btnClearAllData"><i class="fa-solid fa-trash-can"></i> 全データクリア</button>
      </div>
      <p style="font-size:11px; color:var(--text-muted); margin-top:10px; text-align:right;">※ボタンを2回押すと実行されます</p>
    </div>
  </div>
</div>

<script>
(() => {
  const APP_KEY_ALL = "keieiCompassPro_v2";
  const APP_THEME_KEY = "keieiCompassPro_theme";
  
  // Progress State
  let hasSaved = false;
  let hasCopied = false;

  if(window.pdfjsLib){
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
  }

  // --- Definitions (Enhanced Prompts) ---
  const TAB_DEFS = [
    {
      id: "omoi", name: "00 想い・原点", icon: "fa-solid fa-heart", leftTitle: "社長の想い・原点", rightTitle: "ヒアリングシート",
      fields: [
        {k:"company", t:"企業名・屋号", type:"input", ph:"例：株式会社〇〇製作所"},
        {k:"owner", t:"代表者名", type:"input", ph:"例：山田 太郎"},
        {k:"history", t:"創業の経緯・歴史", type:"textarea", ph:"例：先代の急逝で突然継ぐことになり…"},
        {k:"strength", t:"こだわり・強み", type:"textarea", ph:"例：大手にはできない小回りの利く対応…"},
        {k:"customer_voice", t:"顧客の声", type:"textarea", ph:"例：「〇〇さんに頼めば安心だ」…"},
        {k:"vision_raw", t:"将来の夢", type:"textarea", ph:"例：地元で一番愛される店になりたい…"}
      ],
      aiPrompt: (d) => `
# 役割
あなたは実績豊富な**中小企業診断士**であり、優れた**ストーリーテラー**です。

# 指示
以下の「社長インタビューメモ」を読み込み、企業の核心となる価値を言語化してください。
単なる要約ではなく、読む人の心を動かす「企業の物語」として再構築してください。

# インタビューメモ
- 企業名: ${d.company}
- 代表者: ${d.owner}
- 創業経緯: ${d.history}
- こだわり(強み): ${d.strength}
- 顧客の声: ${d.customer_voice}
- ビジョン: ${d.vision_raw}

# 出力フォーマット
1. **創業ストーリー (Narrative)**: 創業の想いとこれまでの歩みを、情緒的かつ論理的に記述。
2. **コア・コンピタンス (Core Competence)**: 顧客に選ばれ続ける「真の強み」を分析的に定義。
3. **経営理念の提案 (Mission/Vision/Value)**: 社長の言葉を昇華させた理念案を3パターン提示。
`
    },
    {
      id: "pest", name: "01 PEST分析", icon: "fa-solid fa-earth-asia", leftTitle: "マクロ環境分析 (PEST)", rightTitle: "PEST分析シート",
      fields: [
        {k:"politics", t:"Politics (政治・法律)", type:"textarea", ph:"例：インボイス制度、法改正、補助金動向など"}, 
        {k:"economy", t:"Economy (経済)", type:"textarea", ph:"例：円安、物価高、賃上げ圧力など"},
        {k:"society", t:"Society (社会)", type:"textarea", ph:"例：少子高齢化、SDGs、タイパ重視など"}, 
        {k:"technology", t:"Technology (技術)", type:"textarea", ph:"例：生成AI、DX、自動化技術など"}
      ],
      aiPrompt: (d) => `
# 役割
あなたはマクロ環境分析の専門家です。

# 指示
以下のPEST分析データを元に、この業界における「構造的な変化」を読み解き、事業に与える影響を予測してください。
表面的な事象の羅列ではなく、「なぜそれが重要か（So What?）」を深掘りしてください。

# PESTデータ
- P (政治・法律): ${d.politics}
- E (経済): ${d.economy}
- S (社会・文化): ${d.society}
- T (技術): ${d.technology}

# 出力フォーマット
1. **マクロ環境サマリー**: PESTそれぞれの要素が絡み合った、現在の市場環境の要約。
2. **機会 (Opportunities)**: 環境変化によって生まれる具体的なビジネスチャンス3選。
3. **脅威 (Threats)**: 放置すると経営を揺るがすリスク3選と、その回避策。
4. **シナリオ予測**: 今後3〜5年で予想される業界の未来図。
`
    },
    {
      id: "3c", name: "02 3C分析", icon: "fa-solid fa-magnifying-glass", leftTitle: "3C分析ボード", rightTitle: "市場環境サマリー",
      fields: [
        {k:"customer", t:"Customer (市場・顧客)", type:"textarea", ph:"例：30-40代子育て世代、健康志向層"}, 
        {k:"competitor", t:"Competitor (競合)", type:"textarea", ph:"例：大手チェーン店（価格）、近隣専門店（品質）"},
        {k:"company", t:"Company (自社)", type:"textarea", ph:"例：創業50年の信頼、独自の加工技術"}, 
        {k:"key_insight", t:"KSF (勝ち筋)", type:"textarea", ph:"例：大手ができない「オーダーメイド」で差別化"}
      ],
      aiPrompt: (d) => `
# 役割
あなたはマーケティング戦略のスペシャリストです。

# 指示
以下の3C分析（Customer, Competitor, Company）の情報を統合し、競合に打ち勝ち、顧客に選ばれるための「KSF（Key Success Factor：主要成功要因）」を明確に定義してください。

# 3Cデータ
- Customer (市場・顧客): ${d.customer}
- Competitor (競合): ${d.competitor}
- Company (自社): ${d.company}
- 仮説KSF: ${d.key_insight}

# 出力フォーマット
1. **市場機会の特定**: 顧客が求めているが、競合が満たせていない「ホワイトスペース」はどこか。
2. **競争優位性**: 自社だけが提供できる独自の価値（USP）は何か。
3. **KSF（勝ち筋）の定義**: 市場で勝つために、リソースを集中すべき「たった一つのポイント」。
4. **戦略オプション**: KSFを実行するための具体的な戦略案（松・竹・梅の3レベルで）。
`
    },
    {
      id: "swot", name: "03 SWOT分析", icon: "fa-solid fa-shield-halved", leftTitle: "環境分析 (SWOT)", rightTitle: "SWOT整理シート",
      fields: [
        {k:"strength", t:"Strength (強み)", type:"textarea", ph:"例：熟練職人の技術、地域密着の基盤"}, 
        {k:"weakness", t:"Weakness (弱み)", type:"textarea", ph:"例：営業力不足、デジタル化の遅れ"},
        {k:"opportunity", t:"Opportunity (機会)", type:"textarea", ph:"例：インバウンド回復、地産地消ブーム"}, 
        {k:"threat", t:"Threat (脅威)", type:"textarea", ph:"例：人口減少、原材料高騰、後継者不足"}
      ],
      aiPrompt: (d) => `
# 役割
あなたは戦略コンサルタントです。

# 指示
以下のSWOT分析を元に、「クロスSWOT分析」を行い、具体的な戦略アクションを立案してください。
一般的な教科書通りの回答ではなく、この企業の文脈に即した実践的な提案を求めます。

# SWOTデータ
- Strength (強み): ${d.strength}
- Weakness (弱み): ${d.weakness}
- Opportunity (機会): ${d.opportunity}
- Threat (脅威): ${d.threat}

# 出力フォーマット
1. **積極攻勢戦略 (S × O)**: 強みを活かして機会を最大化する「攻め」の具体策。
2. **差別化・回避戦略 (S × T)**: 強みで脅威を跳ね返す、または回避する策。
3. **段階的改善戦略 (W × O)**: チャンスを逃さないために、弱みをどう補強するか。
4. **防衛・撤退戦略 (W × T)**: 最悪の事態を避けるためのリスク管理策。
5. **優先順位付け**: 上記の中で、今すぐ取り組むべき「最優先アクション」トップ3。
`
    },
    {
      id: "4p", name: "04 4P施策", icon: "fa-solid fa-shop", leftTitle: "マーケティング・ミックス (4P)", rightTitle: "4P施策シート",
      fields: [
        {k:"product", t:"Product (製品)", type:"textarea", ph:"例：高付加価値なプレミアムライン"}, 
        {k:"price", t:"Price (価格)", type:"textarea", ph:"例：松竹梅の3段階設定"}, 
        {k:"place", t:"Place (流通)", type:"textarea", ph:"例：自社EC直販、地元セレクトショップ"}, 
        {k:"promotion", t:"Promotion (販促)", type:"textarea", ph:"例：SNS発信、LINEクーポン、プレスリリース"}
      ],
      aiPrompt: (d) => `
# 役割
あなたはプロのマーケターです。

# 指示
以下の4P（マーケティング・ミックス）の整合性を診断し、より売上につながる具体的な施策へブラッシュアップしてください。
各要素（Product, Price, Place, Promotion）がターゲット顧客に対して一貫したメッセージになっているか確認してください。

# 4Pデータ
- Product: ${d.product}
- Price: ${d.price}
- Place: ${d.place}
- Promotion: ${d.promotion}

# 出力フォーマット
1. **整合性チェック**: 4つの要素に矛盾はないか（例：高級品なのに安売りしている等）の診断。
2. **施策の具体化**: 
   - どのようなキャッチコピーで訴求するか？
   - 具体的にどこのチャネルを強化するか？
   - 価格設定のロジックは適切か？
3. **プロモーション・カレンダー案**: 今後3ヶ月で実施すべき販促スケジュールの例。
`
    },
    {
      id: "kpi", name: "05 数値・目標", icon: "fa-solid fa-chart-line", leftTitle: "定量目標設定", rightTitle: "経営目標シート",
      fields: [
        {k:"term", t:"対象期間", type:"input", ph:"例：第10期 (202X年4月〜)"}, 
        {k:"sales_goal", t:"売上目標", type:"input", ph:"例：年商 1億円（前年比110%）"}, 
        {k:"profit_goal", t:"利益目標", type:"input", ph:"例：営業利益 1,000万円"}, 
        {k:"kpi", t:"KPI", type:"textarea", ph:"例：新規問合せ月20件、リピート率50%"}, 
        {k:"action", t:"アクションプラン", type:"textarea", ph:"例：4月に新商品リリース、6月に展示会出展"}
      ],
      aiPrompt: (d) => `
# 役割
あなたは経営企画室長です。

# 指示
以下の経営目標（KGI）を達成するためのロジックツリー（KPIツリー）を構築し、現場が動けるレベルのアクションプランに落とし込んでください。
目標数値の根拠（ロジック）を明確にすることを重視してください。

# 目標データ
- 対象期間: ${d.term}
- 売上目標: ${d.sales_goal}
- 利益目標: ${d.profit_goal}
- 設定KPI: ${d.kpi}
- 行動計画: ${d.action}

# 出力フォーマット
1. **KPIツリーの構築**: 売上目標を因数分解し（例：客数×客単価）、各要素の目標値を設定。
2. **ボトルネックの特定**: 目標達成を阻む可能性が高い「最大の壁」は何か。
3. **アクションプラン詳細化**: 
   - 誰が（Who）
   - いつまでに（When）
   - 何を（What）
   - どれくらい（How much）
   やるべきかを箇条書きでリスト化。
`
    },
    {
      id: "plan", name: "06 事業計画骨子", icon: "fa-solid fa-road", leftTitle: "事業計画ドラフト", rightTitle: "事業計画書（案）",
      fields: [
        {k:"title", t:"事業計画タイトル", type:"input", ph:"例：伝統技術を活用した新商品開発事業"}, 
        {k:"background", t:"背景・動機", type:"textarea", ph:"例：既存市場の縮小、新たな顧客層の開拓"}, 
        {k:"service", t:"商品・サービス内容", type:"textarea", ph:"例：若年層向けモダン和雑貨"}, 
        {k:"target", t:"ターゲット・販路", type:"textarea", ph:"例：20-30代女性、SNS経由"}, 
        {k:"schedule", t:"実施スケジュール", type:"textarea", ph:"例：4月開発、6月販売開始"}, 
        {k:"budget", t:"資金計画（概算）", type:"textarea", ph:"例：総額300万（自己資金100万、補助金200万）"}
      ],
      aiPrompt: (d) => `
# 役割
あなたは中小企業診断士であり、補助金申請支援のエキスパートです。

# 指示
以下の情報を元に、**小規模事業者持続化補助金**や**事業再構築補助金**の申請書としても通用するレベルの「事業計画書」の文章を作成してください。
審査員が評価する「実現可能性」「地域への貢献」「革新性」を意識した文章にしてください。

# 計画データ
- タイトル: ${d.title}
- 背景: ${d.background}
- 内容: ${d.service}
- ターゲット: ${d.target}
- 日程: ${d.schedule}
- 予算: ${d.budget}

# 出力フォーマット
1. **事業概要（サマリー）**: 200文字程度で、何をする事業か簡潔に。
2. **顧客ニーズと市場の動向**: なぜ今、この事業が必要なのか。
3. **自社商品・サービスの強み**: 競合他社との違い。
4. **具体的な実施体制とスケジュール**: 実現可能性を示す工程表。
5. **期待される効果**: 売上向上だけでなく、地域経済への波及効果など。
`
    },
    {
      id: "output", name: "07 資料・図解", icon: "fa-solid fa-file-powerpoint", leftTitle: "資料化・図解設定", rightTitle: "資料作成指示書",
      fields: [
        {k:"reader", t:"資料の読者", type:"input", ph:"例：金融機関の担当者、補助金審査員、社内スタッフ"}, 
        {k:"tone", t:"トーン＆マナー", type:"input", ph:"例：信頼感のあるプロフェッショナルなトーン、親しみやすい柔らかい表現"},
        {k:"emphasis", t:"特に強調したい点", type:"textarea", ph:"例：創業からの歴史と新技術の融合、具体的な数値目標の実現可能性"}
      ],
      aiPrompt: (d, allData) => {
        const getVal = (tid, k) => {
          if(allData && allData[tid]) return allData[tid][k] || "（未入力）";
          const local = localStorage.getItem(`kcPro_${tid}`);
          if(local) return JSON.parse(local)[k] || "（未入力）";
          return "（未入力）";
        };

        return `
# 命令
あなたは世界トップクラスの**プレゼンテーション資料作成の専門家**です。
以下の「全方位経営分析データ」をソースとして、読み手を説得し、行動させるための最適なアウトプットを作成してください。

# ターゲット読者
${d.reader || "指定なし"}

# トーン＆マナー
${d.tone || "信頼感のあるプロフェッショナルなトーン"}

# 特に強調したいポイント
${d.emphasis || "指定なし"}

---
# 入力ソースデータ（経営分析結果）
[00 想い] ${getVal("omoi","company")} / ${getVal("omoi","strength")} / ${getVal("omoi","vision_raw")}
[01 PEST] ${getVal("pest","politics")} / ${getVal("pest","economy")} / ${getVal("pest","society")} / ${getVal("pest","technology")}
[02 3C] 市場:${getVal("3c","customer")} / 競合:${getVal("3c","competitor")} / 自社:${getVal("3c","company")} / KSF:${getVal("3c","key_insight")}
[03 SWOT] S:${getVal("swot","strength")} / W:${getVal("swot","weakness")} / O:${getVal("swot","opportunity")} / T:${getVal("swot","threat")}
[04 4P] Prod:${getVal("4p","product")} / Price:${getVal("4p","price")} / Place:${getVal("4p","place")} / Prom:${getVal("4p","promotion")}
[05 目標] 売上:${getVal("kpi","sales_goal")} / 利益:${getVal("kpi","profit_goal")} / KPI:${getVal("kpi","kpi")} / 行動:${getVal("kpi","action")}
[06 計画] 事業名:${getVal("plan","title")} / 内容:${getVal("plan","service")} / 予算:${getVal("plan","budget")}

---
# 作成リクエスト

## 1. スライド構成案（Markdown形式）
PowerPointやGoogleスライドの各ページ構成案を作成してください。
- **表紙**: インパクトのあるタイトル
- **課題**: 現状の問題点
- **解決策**: 提案する事業内容
- **市場性**: 3C/PEST分析に基づく裏付け
- **戦略**: SWOT/4Pに基づく具体的施策
- **計画**: 数値目標とスケジュール
- **まとめ**: 熱意あるメッセージ

## 2. プレゼン台本（スクリプト）
上記スライドに合わせて、プレゼンターが話すべき「台本」を作成してください。
聞き手の共感を呼び、論理的に納得させる構成にしてください。

## 3. 図解作成コード（Mermaid記法）
事業の全体像や成功へのプロセスを可視化するためのMermaidコードを出力してください。
（flowchart LR または graph TD を推奨）
`;
      }
    }
  ];

  // --- DOM & Helpers ---
  const $ = (id) => document.getElementById(id);
  const tabsEl = $("tabs"), formArea = $("formArea"), previewEl = $("preview"), promptPreviewEl = $("promptPreview");
  const toastContainer = $("toastContainer"), fileInput = $("fileInput"), pdfInput = $("pdfInput");
  const btnUsage = $("btnUsage"), usageModal = $("usageModal"), btnCloseUsage = $("btnCloseUsage");
  const btnSettings = $("btnSettings"), settingsModal = $("settingsModal"), btnCloseSettings = $("btnCloseSettings");
  
  const btnViewSheet = $("btnViewSheet"), btnViewPrompt = $("btnViewPrompt");
  const viewSheet = $("viewSheet"), viewPrompt = $("viewPrompt");
  const progressText = $("progressText"), progressFill = $("progressFill");
  const step1 = $("step1"), step2 = $("step2"), step3 = $("step3");
  const arrow1 = $("arrow1"), arrow2 = $("arrow2");

  let activeTabId = TAB_DEFS[0].id;
  let currentView = 'sheet'; 

  function pad(n){ return String(n).padStart(2,"0"); }
  function nowStr(){ const d=new Date(); return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`; }
  function dateFileStr(){ const d=new Date(); return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}`; }
  function tabKey(tabId){ return `kcPro_${tabId}`; }
  function showToast(msg, isError=false){
    const div = document.createElement("div"); div.className = `toast ${isError?"error":""}`;
    div.innerHTML = `<i class="fa-solid ${isError?"fa-circle-exclamation":"fa-circle-check"}"></i> <span>${msg}</span>`;
    toastContainer.appendChild(div);
    requestAnimationFrame(()=>div.classList.add("show"));
    setTimeout(()=>{ div.classList.remove("show"); setTimeout(()=>div.remove(), 400); }, 3000);
  }

  // --- Clipboard Helper ---
  async function copyToClipboard(text) {
    try { await navigator.clipboard.writeText(text); return true; } 
    catch (err) {
      try {
        const ta = document.createElement("textarea"); ta.value = text;
        ta.style.position = "fixed"; ta.style.left = "-9999px"; document.body.appendChild(ta);
        ta.focus(); ta.select(); const success = document.execCommand('copy'); document.body.removeChild(ta);
        return success;
      } catch (e2) { return false; }
    }
  }

  // --- Safety Click ---
  function attachSafetyClick(btnId, actionFn, warningText){
    const btn = $(btnId); let clickCount = 0; let timeout; const originalContent = btn.innerHTML; 
    btn.addEventListener("click", () => {
      if(clickCount === 0){
        clickCount = 1; btn.innerHTML = warningText || "実行しますか？"; btn.classList.add("confirming");
        timeout = setTimeout(() => { clickCount = 0; btn.innerHTML = originalContent; btn.classList.remove("confirming"); }, 3000);
      } else {
        clearTimeout(timeout); clickCount = 0; btn.innerHTML = originalContent; btn.classList.remove("confirming"); actionFn();
      }
    });
  }

  // --- Logic ---
  window.setTheme = function(mode){
    if(mode==='dark'){ document.body.setAttribute('data-theme','dark'); $("themeDark").classList.add("active"); $("themeLight").classList.remove("active"); }
    else{ document.body.removeAttribute('data-theme'); $("themeLight").classList.add("active"); $("themeDark").classList.remove("active"); }
    localStorage.setItem(APP_THEME_KEY, mode);
  }
  function initTheme(){ const s = localStorage.getItem(APP_THEME_KEY); setTheme(s==='dark'?'dark':'light'); }

  function getTabDef(id){ return TAB_DEFS.find(t=>t.id===id); }
  function getCurrentData(id){
    const def = getTabDef(id); const d = {tabId:id, updatedAt:nowStr()};
    def.fields.forEach(f=>{ const el=document.querySelector(`[data-k="${id}.${f.k}"]`); d[f.k]=(el?.value||"").trim(); });
    return d;
  }
  function setCurrentData(id, d){
    const def = getTabDef(id);
    def.fields.forEach(f=>{ const el=document.querySelector(`[data-k="${id}.${f.k}"]`); if(el) el.value=d?.[f.k]??""; });
  }
  
  // Progress Logic
  function updateProgress() {
    let totalFilled = 0;
    let totalFields = 0;
    const inputTabs = TAB_DEFS.filter(t => t.id !== 'output');
    
    inputTabs.forEach(def => {
      let data = {};
      if(def.id === activeTabId) data = getCurrentData(def.id);
      else {
        const raw = localStorage.getItem(tabKey(def.id));
        if(raw) data = JSON.parse(raw);
      }
      
      let filledCount = 0;
      def.fields.forEach(f => {
        if(data[f.k] && data[f.k].trim().length > 0) filledCount++;
      });
      
      const isCompleted = filledCount >= Math.ceil(def.fields.length / 2);
      
      const tabEl = document.querySelector(`.tab[data-id="${def.id}"]`);
      if(tabEl) {
        if(isCompleted) tabEl.classList.add('completed');
        else tabEl.classList.remove('completed');
      }
      
      totalFilled += filledCount;
      totalFields += def.fields.length;
    });
    
    const inputRatio = totalFields > 0 ? (totalFilled / totalFields) : 0;
    let percentage = Math.round(inputRatio * 70); 
    
    if(inputRatio > 0) {
        if(hasSaved) percentage = Math.max(percentage, 85); 
        if(hasCopied) percentage = 100; 
    }
    if(percentage > 100) percentage = 100;
    
    progressText.textContent = `${percentage}%`;
    progressFill.style.width = `${percentage}%`;
    
    if(inputRatio > 0) { step1.classList.add("done"); arrow1.classList.add("done"); }
    else { step1.classList.remove("done"); arrow1.classList.remove("done"); }
    
    if(hasSaved) { step2.classList.add("done"); arrow2.classList.add("done"); }
    else { step2.classList.remove("done"); arrow2.classList.remove("done"); }
    
    if(hasCopied) step3.classList.add("done");
    else step3.classList.remove("done");
  }

  function renderTabs(){
    tabsEl.innerHTML=""; TAB_DEFS.forEach(def=>{
      const b=document.createElement("div"); 
      b.className="tab"+(def.id===activeTabId?" active":"");
      b.setAttribute('data-id', def.id); 
      b.innerHTML=`<i class="${def.icon}"></i> ${def.name}`;
      b.addEventListener("click",()=>{ activeTabId=def.id; renderTabs(); renderForm(); loadTabSilently(); renderPreview(); });
      tabsEl.appendChild(b);
    });
    updateProgress();
  }
  
  function renderForm(){
    const def = getTabDef(activeTabId); $("leftTitle").textContent=def.leftTitle; formArea.innerHTML="";
    def.fields.forEach(f=>{
      const w=document.createElement("div"); w.className="field-wrapper";
      const l=document.createElement("label"); l.textContent=f.t; w.appendChild(l);
      const el=document.createElement(f.type==="input"?"input":"textarea");
      el.setAttribute("data-k", `${activeTabId}.${f.k}`);
      if(f.ph) el.placeholder = f.ph; 
      el.addEventListener("input", () => { renderPreview(); updateProgress(); });
      w.appendChild(el); formArea.appendChild(w);
    });
  }
  
  function renderPreview(){
    const def = getTabDef(activeTabId), d = getCurrentData(activeTabId);
    const l = [`【${def.rightTitle}】`, `作成日: ${d.updatedAt}`, "-".repeat(30)];
    def.fields.forEach(f=>{ if(d[f.k]){ l.push(`■ ${f.t}`); l.push(d[f.k]); l.push(""); } });
    if(l.length<=3) l.push("（未入力）");
    previewEl.textContent = l.join("\n");

    let allData = {};
    if(activeTabId === 'output') {
      TAB_DEFS.forEach(td => {
        const raw = localStorage.getItem(tabKey(td.id));
        if(raw) allData[td.id] = JSON.parse(raw);
        if(td.id === activeTabId) allData[td.id] = d; 
      });
    }

    if(def.fields.some(f=>d[f.k]) || activeTabId === 'output'){
      promptPreviewEl.value = def.aiPrompt(d, allData);
    } else {
      promptPreviewEl.value = "（データを入力すると、ここにAIへの命令文が表示されます）";
    }
  }

  function loadTabSilently(){ 
    const r=localStorage.getItem(tabKey(activeTabId)); 
    if(r) setCurrentData(activeTabId, JSON.parse(r)); 
    renderPreview(); 
    updateProgress();
  }
  
  function saveTab(){ 
    localStorage.setItem(tabKey(activeTabId), JSON.stringify(getCurrentData(activeTabId))); 
    hasSaved = true; 
    showToast("保存しました (進捗 85%)"); 
    updateProgress(); 
  }
  
  window.switchView = function(viewName) {
    currentView = viewName;
    if(viewName === 'sheet'){
      btnViewSheet.classList.add('active'); btnViewPrompt.classList.remove('active');
      viewSheet.classList.add('active'); viewPrompt.classList.remove('active');
    } else {
      btnViewSheet.classList.remove('active'); btnViewPrompt.classList.add('active');
      viewSheet.classList.remove('active'); viewPrompt.classList.add('active');
      renderPreview();
    }
  }

  function generateAiPrompt(){
    switchView('prompt');
    step3.classList.add("done");
    const d=getCurrentData(activeTabId), def=getTabDef(activeTabId);
    if(activeTabId !== 'output' && !def.fields.some(f=>d[f.k])) return showToast("データが空です",true);
    let allData = {};
    if(activeTabId === 'output') {
      TAB_DEFS.forEach(td => {
        const raw = localStorage.getItem(tabKey(td.id));
        if(raw) allData[td.id] = JSON.parse(raw);
        if(td.id === activeTabId) allData[td.id] = d;
      });
    }
    const promptText = def.aiPrompt(d, allData);
    copyToClipboard(promptText).then(ok => {
      hasCopied = true; 
      updateProgress();
      if(ok) showToast("完了！プロンプトをコピーしました (進捗 100%)");
      else showToast("命令文を表示しました", true);
    });
  }
  
  // Modals & Popups
  function openUsage(){ usageModal.classList.add("open"); } function closeUsage(){ usageModal.classList.remove("open"); }
  function openSettings(){ settingsModal.classList.add("open"); } function closeSettings(){ settingsModal.classList.remove("open"); }
  window.onclick = (e) => { if(e.target==usageModal)closeUsage(); if(e.target==settingsModal)closeSettings(); };
  btnUsage.addEventListener("click", openUsage); btnCloseUsage.addEventListener("click", closeUsage);
  btnSettings.addEventListener("click", openSettings); btnCloseSettings.addEventListener("click", closeSettings);

  // --- PDF Text Extraction ---
  $("btnLoadPdf").addEventListener("click", () => pdfInput.click());
  pdfInput.addEventListener("change", async (e) => {
    const file = e.target.files[0]; if (!file) return;
    if (file.type !== "application/pdf") { showToast("PDFファイルを選択してください", true); return; }
    showToast("PDFを解析中...");
    try {
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      let fullText = "";
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const textContent = await page.getTextContent();
        fullText += `--- Page ${i} ---\n` + textContent.items.map(item => item.str).join(" ") + "\n\n";
      }
      const def = getTabDef(activeTabId);
      const lastFieldKey = def.fields[def.fields.length - 1].k;
      const el = document.querySelector(`[data-k="${activeTabId}.${lastFieldKey}"]`);
      if(el) {
        const originalVal = el.value;
        el.value = (originalVal ? originalVal + "\n\n" : "") + "【PDF抽出データ】\n" + fullText;
        el.dispatchEvent(new Event('input'));
        showToast("一番下の欄にPDFを追記しました！");
      } else { showToast("追記先が見つかりませんでした", true); }
    } catch (err) { console.error(err); showToast("PDF読込失敗", true); }
    e.target.value = "";
  });

  // --- Actions ---
  attachSafetyClick("btnClearTab", () => {
    const def=getTabDef(activeTabId); 
    def.fields.forEach(f=>{ const el=document.querySelector(`[data-k="${activeTabId}.${f.k}"]`); if(el) el.value=""; }); 
    renderPreview(); showToast("クリアしました"); updateProgress();
  }, "消去しますか？");

  attachSafetyClick("btnClearAllData", () => { localStorage.clear(); location.reload(); }, "本当に削除？");

  attachSafetyClick("btnLoadDemo", () => {
    try {
      // Demo Data
      const demo = {
        omoi: {
          company: "株式会社 鶴亀堂", owner: "鈴木 一郎",
          history: "創業明治30年。地域で愛される和菓子屋として続いてきたが、近年はコンビニスイーツ等の台頭で売上が低迷。",
          strength: "熟練職人の技術、添加物を使わない製法、地元産素材へのこだわり。",
          customer_voice: "「やっぱりここの大福じゃないと」「孫にも食べさせたい安心の味」",
          vision_raw: "和菓子の伝統を守りつつ、若い世代にも愛される新しい和菓子文化を創りたい。"
        },
        pest: {
          politics: "食品衛生法の改正厳格化。インバウンド観光促進策による地方への誘客。",
          economy: "原材料費の高騰。物価高による買い控え。",
          society: "健康志向の高まり（グルテンフリー、低糖質）。SNS映えするスイーツの流行。",
          technology: "冷凍技術の進化による生菓子の通販可能化。SNSマーケティングの普及。"
        },
        "3c": {
          customer: "30-40代の健康志向の女性。ギフト需要。インバウンド観光客。",
          competitor: "大手コンビニスイーツ（利便性・安さ）、近隣の洋菓子店（映え）、老舗競合（ブランド力）。",
          company: "歴史と伝統、職人技術、無添加、店舗のレトロな雰囲気。",
          key_insight: "「レトロモダン」をテーマに、本物の味とSNS映えを両立させた『ネオ和菓子』で差別化する。"
        },
        swot: {
          strength: "100年の歴史、職人技術、固定客の存在。",
          weakness: "高齢化による後継者不足、Web発信力の弱さ、店舗の老朽化。",
          opportunity: "レトロブーム、和食の世界的認知、通販需要。",
          threat: "原料高、和菓子離れ、後継者不在による廃業。"
        },
        "4p": {
          product: "フルーツ大福、低糖質どら焼き、モダンなパッケージの羊羹。",
          price: "コンビニより高いが百貨店より安い中価格帯（自分へのご褒美）。",
          place: "本店のリニューアル、自社ECサイト、ポップアップストア。",
          promotion: "Instagramでの映え写真投稿、インフルエンサー活用、製造工程の動画配信。"
        },
        kpi: {
          term: "第125期 (2026年度)", sales_goal: "年商 8,000万円（対前年比+20%）", profit_goal: "営業利益 800万円",
          kpi: "新規客数: 月300人、Instagramフォロワー: 5,000人、EC売上比率: 20%",
          action: "毎月新作の開発、週3回のSNS更新、ECサイトのオープン（6月）。"
        },
        plan: {
          title: "伝統×革新：若年層向け『ネオ和菓子』ブランド立ち上げ事業",
          background: "和菓子需要の縮小と原材料高騰への対抗策として、新たな客層の獲得が急務。",
          service: "見た目はモダン、味は本物の新ブランド展開。テイクアウト強化。",
          target: "20-40代女性、観光客。SNS利用者。",
          schedule: "4月:商品開発、5月:店舗改装・EC構築、6月:新装オープン。",
          budget: "総額500万円（改装費300万、HP制作100万、広告宣伝100万）。"
        },
        output: {
          reader: "金融機関の融資担当者、地元の商工会議所",
          tone: "伝統への敬意を払いつつ、革新性を強調する情熱的なトーン",
          emphasis: "100年の歴史とSNSマーケティングの融合による実現可能性の高さ"
        }
      };
      
      TAB_DEFS.forEach(def => {
        const d = demo[def.id] || {};
        def.fields.forEach(f => { if(!d[f.k]) d[f.k] = `(デモ) ${f.t}のサンプル`; });
        d.updatedAt = nowStr(); d.tabId = def.id;
        localStorage.setItem(tabKey(def.id), JSON.stringify(d));
      });
      
      closeSettings(); 
      loadTabSilently(); 
      showToast("デモデータを読み込みました！");
      
    } catch(e) { console.error(e); showToast("読込エラー", true); }
  }, "読込しますか？");

  // --- File I/O ---
  $("btnDownloadJson").addEventListener("click", () => {
    const all = { appId: APP_KEY_ALL, updatedAt: nowStr(), tabs:{} };
    TAB_DEFS.forEach(def => {
      if(def.id === activeTabId) all.tabs[def.id] = getCurrentData(def.id);
      else { const r = localStorage.getItem(tabKey(def.id)); all.tabs[def.id] = r ? JSON.parse(r) : null; }
    });
    const blob = new Blob([JSON.stringify(all,null,2)], {type:"application/json"});
    const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=`KC_${dateFileStr()}.json`;
    document.body.appendChild(a); a.click(); document.body.removeChild(a); showToast("保存しました");
  });
  $("btnUploadJson").addEventListener("click", ()=>fileInput.click());
  fileInput.addEventListener("change", (e)=>{
    const f=e.target.files[0]; if(!f)return;
    const r=new FileReader(); r.onload=(ev)=>{
      try{
        const o=JSON.parse(ev.target.result);
        if(o.tabs){ Object.keys(o.tabs).forEach(k=>{ if(o.tabs[k]) localStorage.setItem(tabKey(k),JSON.stringify(o.tabs[k])); });
        loadTabSilently(); renderPreview(); showToast("復元しました"); }
        else showToast("形式エラー",true);
      }catch(e){ showToast("読込エラー",true); }
    }; r.readAsText(f); e.target.value="";
  });

  $("btnSaveTab").addEventListener("click", saveTab);
  $("btnGenAiPrompt").addEventListener("click", generateAiPrompt);
  
  $("btnCopyRight").addEventListener("click", ()=>{ 
    // Copy depending on active view
    const textToCopy = currentView === 'prompt' ? promptPreviewEl.value : previewEl.textContent;
    copyToClipboard(textToCopy).then(ok => {
      if(ok) showToast("コピーしました");
      else showToast("コピー失敗", true);
    });
  });

  // Init
  initTheme(); renderTabs(); renderForm(); loadTabSilently(); renderPreview();
})();
</script>
</body>
</html>